<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾é£Ÿç«™é»é¤ç³»çµ± | Food Stand Ordering</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Righteous&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E85A2A;
            --secondary: #F7931E;
            --accent: #FDC830;
            --success: #4CAF50;
            --danger: #E63946;
            --bg-light: #FFF9F0;
            --bg-white: #FFFFFF;
            --text-dark: #2D3142;
            --text-muted: #6B6B6B;
            --shadow: rgba(255, 107, 53, 0.15);
            --border: #FFE5D9;
        }

        .dark {
            --bg-light: #1a1a2e;
            --bg-white: #16213e;
            --text-dark: #eaeaea;
            --text-muted: #a0a0a0;
            --shadow: rgba(0, 0, 0, 0.3);
            --border: #2d3142;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -5%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .header h1 {
            font-family: 'Righteous', cursive;
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .toggle-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 0 4px 10px var(--shadow);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow);
        }

        .toggle-btn:not(.active) {
            background: var(--bg-white);
            color: var(--text-dark);
        }

        .toggle-btn:hover:not(.active) {
            transform: translateY(-2px);
        }

        /* Menu Items */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .menu-item {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow);
            transition: all 0.3s ease;
            border: 2px solid var(--border);
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px var(--shadow);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .item-emoji {
            font-size: 3em;
            filter: drop-shadow(2px 2px 4px var(--shadow));
        }

        .item-info h3 {
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .item-info .english {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .item-price {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--secondary);
            margin: 15px 0;
        }

        .add-drink-option {
            background: var(--bg-light);
            padding: 12px;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-drink-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .qty-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--primary);
            background: var(--bg-white);
            color: var(--primary);
            border-radius: 50%;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .qty-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .qty-display {
            font-size: 1.5em;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .add-to-cart {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .add-to-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow);
        }

        /* Cart Summary */
        .cart-summary {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-white);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow);
            min-width: 280px;
            border: 2px solid var(--primary);
            z-index: 100;
        }

        .cart-summary h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .cart-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.95em;
        }

        .cart-total {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--secondary);
            margin: 15px 0;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .submit-order {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--success), #45a049);
            color: white;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.3s ease;
        }

        .submit-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .submit-order:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        /* Order Confirmation Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .order-number {
            font-size: 4em;
            font-weight: 700;
            color: var(--primary);
            margin: 20px 0;
            font-family: 'Righteous', cursive;
        }

        .modal-close {
            margin-top: 20px;
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* Kitchen View */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .order-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow);
            border-left: 6px solid var(--primary);
            transition: all 0.3s ease;
        }

        .order-card.completed {
            border-left-color: var(--success);
            opacity: 0.7;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .order-number-display {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Righteous', cursive;
        }

        .order-time {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .order-items {
            margin: 15px 0;
        }

        .order-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .complete-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: var(--success);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.3s ease;
        }

        .complete-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .completed-badge {
            background: var(--success);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Statistics Cards */
        .stat-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow);
            border-left: 6px solid var(--secondary);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-emoji {
            font-size: 2.5em;
        }

        .stat-name {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
        }

        .stat-numbers {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .stat-count {
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-max {
            font-size: 1.5em;
            color: var(--text-muted);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--secondary));
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--secondary), var(--accent));
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), var(--primary));
        }

        /* Settings Cards */
        .settings-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow);
            border: 2px solid var(--border);
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-light);
            color: var(--text-dark);
            margin-top: 10px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .cart-summary {
                position: relative;
                bottom: auto;
                right: auto;
                margin: 20px 0;
            }

            .orders-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            html:not(.light-mode) {
                --bg-light: #1a1a2e;
                --bg-white: #16213e;
                --text-dark: #eaeaea;
                --text-muted: #a0a0a0;
                --shadow: rgba(0, 0, 0, 0.3);
                --border: #2d3142;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ´ ç¾é£Ÿç«™ Food Stand</h1>
        <p>æ­¡è¿å…‰è‡¨ï¼Welcome to our delicious world</p>
    </div>

    <div class="container">
        <div class="view-toggle">
            <button class="toggle-btn active" onclick="switchView('customer')">
                ğŸ‘¥ é¡§å®¢é»é¤ | Customer Order
            </button>
            <button class="toggle-btn" onclick="switchView('kitchen')">
                ğŸ‘¨â€ğŸ³ å»šæˆ¿ç®¡ç† | Kitchen View
            </button>
        </div>

        <!-- Customer View -->
        <div id="customerView">
            <div class="menu-grid" id="menuGrid"></div>

            <div class="cart-summary" id="cartSummary" style="display: none;">
                <h3>ğŸ›’ è³¼ç‰©è»Š | Cart</h3>
                <div id="cartItems"></div>
                <div class="cart-total">
                    ç¸½è¨ˆ Total: <span id="cartTotal">0</span> NTD
                </div>
                <button class="submit-order" onclick="submitOrder()">
                    âœ… ç¢ºèªè¨‚å–® | Submit Order
                </button>
            </div>
        </div>

        <!-- Kitchen View -->
        <div id="kitchenView" class="hidden">
            <!-- Management Tabs -->
            <div class="view-toggle" style="margin-bottom: 20px;">
                <button class="toggle-btn active" onclick="showKitchenTab('orders')">ğŸ“¦ è¨‚å–® | Orders</button>
                <button class="toggle-btn" onclick="showKitchenTab('statistics')">ğŸ“Š çµ±è¨ˆ | Statistics</button>
                <button class="toggle-btn" onclick="showKitchenTab('settings')">âš™ï¸ è¨­å®š | Settings</button>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab">
                <!-- Reset Buttons -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="complete-btn" onclick="clearCompletedOrders()" style="background: var(--secondary);">
                        ğŸ—‘ï¸ æ¸…é™¤å·²å®Œæˆè¨‚å–® | Clear Completed Orders
                    </button>
                    <button class="complete-btn" onclick="resetAllOrders()" style="background: var(--danger);">
                        â™»ï¸ é‡ç½®æ‰€æœ‰è¨‚å–® | Reset All Orders
                    </button>
                    <button class="complete-btn" onclick="resetOrderCounter()" style="background: var(--text-muted);">
                        ğŸ”¢ é‡ç½®è¨‚å–®ç·¨è™Ÿ | Reset Order Counter
                    </button>
                </div>

                <!-- Pending Orders -->
                <div id="pendingSection">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ”¥ å¾…è™•ç†è¨‚å–® | Pending Orders</h2>
                    <div class="orders-grid" id="pendingOrdersGrid"></div>
                    <div id="emptyStatePending" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">âœ…</div>
                        <h2>æ‰€æœ‰è¨‚å–®å·²å®Œæˆ | All Orders Completed</h2>
                    </div>
                </div>

                <!-- Completed Orders -->
                <div id="completedSection" style="margin-top: 40px;">
                    <h2 style="color: var(--success); margin-bottom: 20px;">âœ… å·²å®Œæˆè¨‚å–® | Completed Orders</h2>
                    <div class="orders-grid" id="completedOrdersGrid"></div>
                    <div id="emptyStateCompleted" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <h2>å°šç„¡å®Œæˆè¨‚å–® | No Completed Orders Yet</h2>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statisticsTab" class="hidden">
                <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Š éŠ·å”®çµ±è¨ˆ | Sales Statistics</h2>
                <div id="statisticsGrid" class="menu-grid"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="hidden">
                <!-- Site Name Settings -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸª ç«™é»åç¨± | Site Name</h2>
                    <div class="settings-card">
                        <label style="font-size: 0.9em; color: var(--text-muted);">è¡¨æƒ…ç¬¦è™Ÿ | Emoji</label>
                        <input type="text" id="siteEmoji" class="settings-input" placeholder="ğŸ´" maxlength="2">

                        <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">ä¸­æ–‡åç¨± | Chinese Name</label>
                        <input type="text" id="siteNameCh" class="settings-input" placeholder="ç¾é£Ÿç«™">

                        <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">è‹±æ–‡åç¨± | English Name</label>
                        <input type="text" id="siteNameEn" class="settings-input" placeholder="Food Stand">

                        <button class="complete-btn" onclick="saveSiteName()" style="margin-top: 15px;">
                            ğŸ’¾ å„²å­˜åç¨± | Save Name
                        </button>
                    </div>
                </div>

                <!-- Color Theme -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ¨ é¡è‰²ä¸»é¡Œ | Color Theme</h2>
                    <div id="colorThemeSelector" class="menu-grid"></div>
                </div>

                <!-- Menu Items Management -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ½ï¸ èœå–®é …ç›®ç®¡ç† | Menu Items Management</h2>
                    <button class="submit-order" onclick="showAddItemModal()" style="max-width: 300px; margin-bottom: 20px;">
                        â• æ–°å¢é …ç›® | Add New Item
                    </button>
                    <div id="menuManagementGrid" class="menu-grid"></div>
                </div>

                <!-- Extra Options Management -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ é¡å¤–é¸é …ç®¡ç† | Extra Options Management</h2>
                    <button class="submit-order" onclick="showAddExtraOptionModal()" style="max-width: 300px; margin-bottom: 20px;">
                        â• æ–°å¢é¸é … | Add New Option
                    </button>
                    <div id="extraOptionsGrid" class="menu-grid"></div>
                </div>

                <!-- Inventory Settings -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“¦ åº«å­˜è¨­å®š | Inventory Settings</h2>
                    <div id="settingsGrid" class="menu-grid"></div>
                </div>

                <!-- Firebase Sync Settings -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">â˜ï¸ Firebase åŒæ­¥ | Firebase Sync</h2>
                    <div class="settings-card" style="max-width: 800px;">
                        <p style="margin-bottom: 15px; color: var(--text-muted); font-size: 0.9em;">
                            è«‹å¾ Firebase Console è¤‡è£½æ‚¨çš„è¨­å®š | Please copy your config from Firebase Console
                        </p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">API Key *</label>
                                <input type="text" id="apiKeyInput" class="settings-input" placeholder="AIzaSyXXXXX...">
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">Auth Domain</label>
                                <input type="text" id="authDomainInput" class="settings-input" placeholder="your-project.firebaseapp.com">
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">Database URL *</label>
                                <input type="text" id="databaseURLInput" class="settings-input" placeholder="https://your-project.firebaseio.com">
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">Project ID</label>
                                <input type="text" id="projectIdInput" class="settings-input" placeholder="your-project">
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">Storage Bucket</label>
                                <input type="text" id="storageBucketInput" class="settings-input" placeholder="your-project.appspot.com">
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: var(--text-muted);">Messaging Sender ID</label>
                                <input type="text" id="messagingSenderIdInput" class="settings-input" placeholder="123456789">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="font-size: 0.9em; color: var(--text-muted);">App ID</label>
                                <input type="text" id="appIdInput" class="settings-input" placeholder="1:123456789:web:xxxxx">
                            </div>
                        </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="complete-btn" onclick="saveFirebaseConfig()">
                                ğŸ’¾ é€£æ¥Firebase | Connect Firebase
                            </button>
                            <button class="complete-btn" onclick="loadFromFirebase()" style="background: var(--secondary);">
                                â¬‡ï¸ å¾Firebaseè¼‰å…¥ | Load from Firebase
                            </button>
                            <button class="complete-btn" onclick="saveToFirebase()" style="background: var(--primary);">
                                â¬†ï¸ å„²å­˜åˆ°Firebase | Save to Firebase
                            </button>
                            <button class="complete-btn" onclick="enableRealtimeSync()" style="background: var(--success);">
                                ğŸ”„ å•Ÿç”¨å³æ™‚åŒæ­¥ | Enable Real-time Sync
                            </button>
                        </div>
                        <div id="syncStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>

                        <details style="margin-top: 20px; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                            <summary style="cursor: pointer; font-weight: 700; color: var(--primary);">ğŸ“– å¦‚ä½•è¨­å®š Firebase | How to Setup Firebase</summary>
                            <ol style="margin-top: 15px; line-height: 1.8; color: var(--text-dark);">
                                <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" style="color: var(--primary);">Firebase Console</a></li>
                                <li>å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ | Create new project or select existing</li>
                                <li>é»æ“Šå·¦å´ "Realtime Database" â†’ å»ºç«‹è³‡æ–™åº« (æ¸¬è©¦æ¨¡å¼) | Click "Realtime Database" â†’ Create Database (test mode)</li>
                                <li>é»æ“Šå°ˆæ¡ˆè¨­å®š (é½’è¼ªåœ–ç¤º) â†’ å‘ä¸‹æ»¾å‹•åˆ° "æ‚¨çš„æ‡‰ç”¨ç¨‹å¼" | Click Project Settings (gear icon) â†’ Scroll to "Your apps"</li>
                                <li>é»æ“Šç¶²é åœ–ç¤º &lt;/&gt; æ–°å¢æ‡‰ç”¨ç¨‹å¼ | Click web icon &lt;/&gt; to add web app</li>
                                <li>è¤‡è£½ firebaseConfig ç‰©ä»¶ä¸­çš„å€¼åˆ°ä¸Šæ–¹æ¬„ä½ | Copy values from firebaseConfig object to fields above</li>
                                <li>é»æ“Š "é€£æ¥Firebase" æŒ‰éˆ• | Click "Connect Firebase" button</li>
                            </ol>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2>âœ… è¨‚å–®å·²ç¢ºèªï¼</h2>
            <h3>Order Confirmed!</h3>
            <div style="margin: 20px 0;">
                <p style="font-size: 1.2em; margin-bottom: 10px;">æ‚¨çš„å–é¤è™Ÿç¢¼ | Your Order Number:</p>
                <div class="order-number" id="modalOrderNumber"></div>
            </div>
            <p style="color: var(--text-muted);">è«‹ç­‰å€™å«è™Ÿ | Please wait for your number</p>
            <button class="modal-close" onclick="closeModal()">
                é—œé–‰ | Close
            </button>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h2>ğŸ”’ å»šæˆ¿ç®¡ç†ç™»å…¥</h2>
            <h3>Kitchen Access Login</h3>
            <div style="margin: 30px 0;">
                <input type="password" id="passwordInput"
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼ | Enter password"
                    style="width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid var(--border); border-radius: 12px; background: var(--bg-light); color: var(--text-dark);">
                <div id="passwordError" style="color: var(--danger); margin-top: 10px; display: none;">
                    âŒ å¯†ç¢¼éŒ¯èª¤ | Incorrect password
                </div>
            </div>
            <button class="modal-close" onclick="verifyPassword()">
                ç™»å…¥ | Login
            </button>
            <button class="modal-close" onclick="closePasswordModal()" style="background: var(--text-muted); margin-top: 10px;">
                å–æ¶ˆ | Cancel
            </button>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="itemModalTitle">â• æ–°å¢èœå–®é …ç›® | Add Menu Item</h2>
            <div style="margin: 20px 0; text-align: left;">
                <input type="hidden" id="editItemId">
                <label style="font-size: 0.9em; color: var(--text-muted);">è¡¨æƒ…ç¬¦è™Ÿ | Emoji</label>
                <input type="text" id="itemEmoji" class="settings-input" placeholder="ğŸ”" maxlength="2">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">ä¸­æ–‡åç¨± | Chinese Name</label>
                <input type="text" id="itemNameCh" class="settings-input" placeholder="ç¾å‘³æ¼¢å ¡">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">è‹±æ–‡åç¨± | English Name</label>
                <input type="text" id="itemNameEn" class="settings-input" placeholder="Delicious Burger">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">åƒ¹æ ¼ | Price (NTD)</label>
                <input type="number" id="itemPrice" class="settings-input" placeholder="100" min="0">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">æœ€å¤§åº«å­˜ | Max Inventory</label>
                <input type="number" id="itemMaxInventory" class="settings-input" placeholder="50" min="0">
            </div>
            <button class="modal-close" onclick="saveItem()">
                ğŸ’¾ å„²å­˜ | Save
            </button>
            <button class="modal-close" onclick="closeItemModal()" style="background: var(--text-muted); margin-top: 10px;">
                å–æ¶ˆ | Cancel
            </button>
        </div>
    </div>

    <!-- Add/Edit Extra Option Modal -->
    <div class="modal" id="extraOptionModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="extraOptionModalTitle">â• æ–°å¢é¡å¤–é¸é … | Add Extra Option</h2>
            <div style="margin: 20px 0; text-align: left;">
                <input type="hidden" id="editExtraOptionId">
                <label style="font-size: 0.9em; color: var(--text-muted);">ä¸­æ–‡åç¨± | Chinese Name</label>
                <input type="text" id="extraOptionNameCh" class="settings-input" placeholder="åŠ è³¼é£²æ–™">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">è‹±æ–‡åç¨± | English Name</label>
                <input type="text" id="extraOptionNameEn" class="settings-input" placeholder="Add Drink">

                <label style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px; display: block;">åƒ¹æ ¼ | Price (NTD)</label>
                <input type="number" id="extraOptionPrice" class="settings-input" placeholder="15" min="0">
            </div>
            <button class="modal-close" onclick="saveExtraOption()">
                ğŸ’¾ å„²å­˜ | Save
            </button>
            <button class="modal-close" onclick="closeExtraOptionModal()" style="background: var(--text-muted); margin-top: 10px;">
                å–æ¶ˆ | Cancel
            </button>
        </div>
    </div>

    <!-- App JS: unified, safe initialization -->
    <script>
    (function () {
      /* -------------------------
         Default Data & State
         ------------------------- */
      const defaultMenuItems = [
        { id: 1, emoji: 'ğŸ¥˜', nameCh: 'å’–å“©é¦™è…¸é¤ç›’', nameEn: 'Curry Sausage Meal Box', price: 100, canAddDrink: true },
        { id: 2, emoji: 'ğŸŒ­', nameCh: 'ç¾å¼ç†±ç‹—å ¡', nameEn: 'American Hot Dog', price: 75, canAddDrink: true },
        { id: 3, emoji: 'ğŸ', nameCh: 'å¾·åœ‹å¤–å©†è˜‹æœè›‹ç³•', nameEn: "German Grandma's Apple Cake", price: 85, canAddDrink: true },
        { id: 4, emoji: 'ğŸŠ', nameCh: 'è¾²èŠé‡‘æ¡”ç³–æ¼¿æ°£æ³¡æ°´', nameEn: 'Farm Kumquat Syrup Sparkling Water', price: 35, canAddDrink: false }
      ];

      // Ensure globals exist or set defaults
      window.menuItems = window.menuItems || defaultMenuItems.slice();
      window.cart = window.cart || [];
      window.orderCounter = window.orderCounter || 0;
      window.orders = window.orders || [];
      window.maxInventory = window.maxInventory || { 1:50, 2:50, 3:30, 4:100 };
      window.currentTheme = window.currentTheme || 'orange';
      window.siteName = window.siteName || { chinese: 'ç¾é£Ÿç«™', english: 'Food Stand', emoji: 'ğŸ´' };
      window.extraOptions = window.extraOptions || [{ id:1, nameCh:'åŠ è³¼é£²æ–™', nameEn:'Add Drink', price:15 }];
      window.nextItemId = window.nextItemId || 5;
      window.nextExtraOptionId = window.nextExtraOptionId || 2;

      // Expose firebaseConfig placeholder if not present
      window.firebaseConfig = window.firebaseConfig || {
        apiKey: "AIzaSyD7cWCX1_GQ1V0SCWEo5tAtmNWYX4DGwIg",
        authDomain: "german-sausage.firebaseapp.com",
        databaseURL: "https://german-sausage-default-rtdb.firebaseio.com",
        projectId: "german-sausage",
        storageBucket: "german-sausage.firebasestorage.app",
        messagingSenderId: "951839734578",
        appId: "1:951839734578:web:d0a8bf70520460cd97b52b",
        configured: false
      };

      // firebaseDb will be set by initialization
      window.firebaseDb = window.firebaseDb || null;

      // Safety flag for realtime
      window.realtimeSyncEnabled = typeof window.realtimeSyncEnabled === 'boolean' ? window.realtimeSyncEnabled : false;

      // Kitchen auth
      window.KITCHEN_PASSWORD = window.KITCHEN_PASSWORD || '1234';
      window.isKitchenAuthenticated = window.isKitchenAuthenticated || false;

      /* -------------------------
         Utility helpers
         ------------------------- */
      function el(id) { return document.getElementById(id); }
      function safeText(n) { return n === undefined || n === null ? '' : n; }
      function formatTime(iso) {
        try {
          return new Date(iso).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        } catch (e) { return iso || ''; }
      }

      /* -------------------------
         Basic UI helpers (popups/status)
         ------------------------- */
      window.showSyncStatus = function (message, type = 'success') {
        const statusDiv = el('syncStatus');
        if (!statusDiv) { console.log(message); return; }
        statusDiv.style.display = 'block';
        statusDiv.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        statusDiv.style.color = 'white';
        statusDiv.textContent = message;
        clearTimeout(window.__syncStatusTimer);
        window.__syncStatusTimer = setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
      };

      window._showConfirmDialogFallback = function (message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.zIndex = 3000;
        modal.innerHTML = `
          <div class="modal-content" style="max-width:520px;">
            <p style="font-size:1.05em;margin-bottom:20px;">${message}</p>
            <div style="display:flex;gap:10px;justify-content:center;">
              <button class="modal-close" id="__confirm_cancel" style="background:var(--text-muted)">å–æ¶ˆ</button>
              <button class="modal-close" id="__confirm_ok">ç¢ºèª</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#__confirm_cancel').onclick = () => modal.remove();
        modal.querySelector('#__confirm_ok').onclick = () => { modal.remove(); onConfirm && onConfirm(); };
      };

      window.showConfirmDialog = function(message, onConfirm) {
        // Use fallback modal
        window._showConfirmDialogFallback(message, onConfirm);
      };

      /* -------------------------
         Firebase safe init wrapper
         ------------------------- */
      window.initializeFirebaseSafe = function () {
        try {
          if (window.firebaseConfig && window.firebaseConfig.configured && window.firebaseDb) {
            console.log('âš ï¸ Firebase already configured (safe).');
            return true;
          }
          if (!window.firebase) { console.warn('Firebase SDK not loaded'); return false; }
          if (!window.firebaseConfig || !window.firebaseConfig.apiKey || !window.firebaseConfig.databaseURL) {
            console.warn('No firebaseConfig present or incomplete; skipping init');
            return false;
          }
          firebase.initializeApp(window.firebaseConfig);
          window.firebaseDb = firebase.database();
          window.firebaseConfig.configured = true;
          console.log('âœ… Firebase initialized (safe).');
          return true;
        } catch (err) {
          console.error('Firebase init error (safe):', err);
          return false;
        }
      };

      /* -------------------------
         Core App functions (rendering)
         ------------------------- */
      window.renderMenu = function () {
        const menuGrid = el('menuGrid');
        if (!menuGrid) return;
        menuGrid.innerHTML = window.menuItems.map(item => `
          <div class="menu-item">
            <div class="item-header">
              <div class="item-emoji">${item.emoji}</div>
              <div class="item-info">
                <h3>${item.nameCh}</h3>
                <div class="english">${item.nameEn}</div>
              </div>
            </div>
            <div class="item-price">${item.price} NTD</div>
            ${item.canAddDrink ? `
              <div class="add-drink-option">
                <input type="checkbox" id="drink-${item.id}" onchange="updateItemTotal && updateItemTotal(${item.id})">
                <label for="drink-${item.id}">
                  åŠ è³¼é£²æ–™ +15 NTD<br>
                  <span style="font-size:0.9em;color:var(--text-muted);">Add Drink +15 NTD</span>
                </label>
              </div>
            ` : ''}
            <div class="quantity-control">
              <button class="qty-btn" onclick="changeQuantity(${item.id}, -1)">-</button>
              <div class="qty-display" id="qty-${item.id}">0</div>
              <button class="qty-btn" onclick="changeQuantity(${item.id}, 1)">+</button>
            </div>
            <button class="add-to-cart" onclick="addToCart(${item.id})">åŠ å…¥è³¼ç‰©è»Š | Add to Cart</button>
          </div>
        `).join('');
      };

      window.updateCartDisplay = function () {
        const cartSummary = el('cartSummary');
        const cartItems = el('cartItems');
        const cartTotal = el('cartTotal');
        if (!cartSummary || !cartItems || !cartTotal) return;

        if (!window.cart || window.cart.length === 0) {
          cartSummary.style.display = 'none';
          cartItems.innerHTML = '';
          cartTotal.textContent = '0';
          return;
        }

        cartSummary.style.display = 'block';
        cartItems.innerHTML = window.cart.map(it => `
          <div class="cart-item">
            ${it.emoji} ${it.nameCh} x${it.quantity}
            ${it.addDrink ? '<br>ã€€ã€€+ é£²æ–™ (Drink)' : ''}
            <br>ã€€ã€€${it.totalPrice} NTD
          </div>
        `).join('');

        const total = window.cart.reduce((s, i) => s + (i.totalPrice || 0), 0);
        cartTotal.textContent = total;
      };

      window.changeQuantity = function (itemId, delta) {
        const qtyEl = el(`qty-${itemId}`);
        if (!qtyEl) return;
        let current = parseInt(qtyEl.textContent || '0', 10);
        current = Math.max(0, current + delta);
        qtyEl.textContent = current;
        if (window.updateItemTotal) try { window.updateItemTotal(itemId); } catch (e) {}
      };

      window.addToCart = function (itemId) {
        const item = window.menuItems.find(i => i.id === itemId);
        if (!item) return;
        const qtyEl = el(`qty-${itemId}`);
        const qty = qtyEl ? parseInt(qtyEl.textContent || '0', 10) : 0;
        if (qty <= 0) return;
        const addDrink = item.canAddDrink && el(`drink-${itemId}`) ? el(`drink-${itemId}`).checked : false;
        const totalPrice = (item.price + (addDrink ? 15 : 0)) * qty;
        window.cart.push({ id: item.id, emoji: item.emoji, nameCh: item.nameCh, nameEn: item.nameEn, quantity: qty, addDrink, totalPrice });
        if (qtyEl) qtyEl.textContent = '0';
        if (item.canAddDrink && el(`drink-${itemId}`)) el(`drink-${itemId`).checked = false;
        window.updateCartDisplay();
      };

      window.submitOrder = function () {
        if (!window.cart || window.cart.length === 0) return;
        window.orderCounter = (window.orderCounter || 0) + 1;
        const order = {
          orderNumber: window.orderCounter,
          items: JSON.parse(JSON.stringify(window.cart)),
          total: window.cart.reduce((s,i)=>s+(i.totalPrice||0),0),
          timestamp: new Date().toISOString(),
          completed: false
        };
        window.orders.unshift(order);
        window.saveToFirebase && window.saveToFirebase();
        const modalOrderNumber = el('modalOrderNumber');
        if (modalOrderNumber) modalOrderNumber.textContent = window.orderCounter;
        const orderModal = el('orderModal');
        if (orderModal) orderModal.classList.add('show');
        window.cart = [];
        window.updateCartDisplay();
        window.renderPendingOrders && window.renderPendingOrders();
        window.renderStatistics && window.renderStatistics();
      };

      window.closeModal = function () {
        const orderModal = el('orderModal');
        if (orderModal) orderModal.classList.remove('show');
      };

      /* -------------------------
         Kitchen & Admin Renderers
         ------------------------- */
      function calculateItemStats() {
        const stats = {};
        window.menuItems.forEach(m => stats[m.id] = 0);
        window.orders.forEach(o => (o.items || []).forEach(i => { stats[i.id] = (stats[i.id]||0) + (i.quantity||0); }));
        return stats;
      }

      window.renderStatistics = function () {
        const statsGrid = el('statisticsGrid');
        if (!statsGrid) return;
        const stats = calculateItemStats();
        statsGrid.innerHTML = window.menuItems.map(item => {
          const sold = stats[item.id] || 0;
          const max = window.maxInventory[item.id] || 0;
          const percentage = max > 0 ? (sold / max) * 100 : 0;
          let progressClass = '';
          if (percentage >= 90) progressClass = 'danger';
          else if (percentage >= 70) progressClass = 'warning';
          return `
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-emoji">${item.emoji}</div>
                <div>
                  <div class="stat-name">${item.nameCh}</div>
                  <div style="font-size: 0.85em; color: var(--text-muted);">${item.nameEn}</div>
                </div>
              </div>
              <div class="stat-numbers">
                <div class="stat-count">
                  <div class="stat-label">å·²å”®å‡º | Sold</div>
                  <div class="stat-value">${sold}</div>
                </div>
                <div style="font-size: 1.5em; color: var(--text-muted);">/</div>
                <div class="stat-count">
                  <div class="stat-label">æœ€å¤§é‡ | Max</div>
                  <div class="stat-max">${max}</div>
                </div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentage,100)}%"></div>
              </div>
            </div>
          `;
        }).join('');
      };

      window.renderSettings = function () {
        const settingsGrid = el('settingsGrid');
        if (!settingsGrid) return;
        settingsGrid.innerHTML = window.menuItems.map(item => `
          <div class="settings-card">
            <div class="stat-header">
              <div class="stat-emoji">${item.emoji}</div>
              <div>
                <div class="stat-name">${item.nameCh}</div>
                <div style="font-size:0.85em;color:var(--text-muted);">${item.nameEn}</div>
              </div>
            </div>
            <label style="font-size:0.9em;color:var(--text-muted);">æœ€å¤§åº«å­˜é‡ | Max Inventory</label>
            <input type="number" class="settings-input" value="${window.maxInventory[item.id]||0}" onchange="updateMaxInventory(${item.id}, this.value)" min="0">
          </div>
        `).join('');
      };

      window.updateMaxInventory = function (itemId, value) {
        window.maxInventory[itemId] = parseInt(value || '0', 10) || 0;
        window.renderStatistics && window.renderStatistics();
        window.saveToFirebase && window.saveToFirebase();
      };

      window.renderPendingOrders = function () {
        const pendingGrid = el('pendingOrdersGrid');
        const emptyState = el('emptyStatePending');
        if (!pendingGrid || !emptyState) return;
        const pending = window.orders.filter(o => !o.completed);
        if (pending.length === 0) {
          pendingGrid.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }
        emptyState.style.display = 'none';
        pendingGrid.innerHTML = pending.map(order => `
          <div class="order-card">
            <div class="order-card-header">
              <div class="order-number-display">#${order.orderNumber}</div>
              <div class="order-time">${formatTime(order.timestamp)}</div>
            </div>
            <div class="order-items">
              ${(order.items || []).map(i => `<div class="order-item">${i.emoji} ${i.nameCh} x${i.quantity}${i.addDrink?'<br>ã€€ã€€+ é£²æ–™ (Drink)':''}</div>`).join('')}
            </div>
            <div class="cart-total" style="font-size:1.3em;">ç¸½è¨ˆ Total: ${order.total} NTD</div>
            <button class="complete-btn" onclick="completeOrder(${order.orderNumber})">âœ… å®Œæˆè¨‚å–® | Complete Order</button>
          </div>
        `).join('');
      };

      window.renderCompletedOrders = function () {
        const completedGrid = el('completedOrdersGrid');
        const emptyState = el('emptyStateCompleted');
        if (!completedGrid || !emptyState) return;
        const completed = window.orders.filter(o => o.completed);
        if (completed.length === 0) {
          completedGrid.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }
        emptyState.style.display = 'none';
        completedGrid.innerHTML = completed.map(order => `
          <div class="order-card completed">
            <div class="order-card-header">
              <div class="order-number-display">#${order.orderNumber}</div>
              <div class="order-time">${formatTime(order.timestamp)}</div>
            </div>
            <div class="order-items">
              ${(order.items || []).map(i => `<div class="order-item">${i.emoji} ${i.nameCh} x${i.quantity}${i.addDrink?'<br>ã€€ã€€+ é£²æ–™ (Drink)':''}</div>`).join('')}
            </div>
            <div class="cart-total" style="font-size:1.3em;">ç¸½è¨ˆ Total: ${order.total} NTD</div>
            <div class="completed-badge">âœ… å·²å®Œæˆ Completed</div>
          </div>
        `).join('');
      };

      window.completeOrder = function (orderNumber) {
        const ord = window.orders.find(o=>o.orderNumber===orderNumber);
        if (!ord) return;
        ord.completed = true;
        window.renderPendingOrders && window.renderPendingOrders();
        window.renderCompletedOrders && window.renderCompletedOrders();
        window.renderStatistics && window.renderStatistics();
        window.saveToFirebase && window.saveToFirebase();
      };

      /* -------------------------
         Menu management (admin)
         ------------------------- */
      window.renderMenuManagement = function () {
        const grid = el('menuManagementGrid');
        if (!grid) return;
        grid.innerHTML = window.menuItems.map(item => `
          <div class="settings-card">
            <div class="stat-header">
              <div class="stat-emoji">${item.emoji}</div>
              <div>
                <div class="stat-name">${item.nameCh}</div>
                <div style="font-size:0.85em;color:var(--text-muted);">${item.nameEn}</div>
              </div>
            </div>
            <div style="margin-top:15px;">
              <div style="font-size:1.3em;color:var(--secondary);font-weight:700;">${item.price} NTD</div>
            </div>
            <div style="margin-top:15px;display:flex;gap:10px;">
              <button class="complete-btn" onclick="editItem(${item.id})" style="flex:1;background:var(--secondary)">âœï¸ ç·¨è¼¯</button>
              <button class="complete-btn" onclick="deleteItem(${item.id})" style="flex:1;background:var(--danger)">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
          </div>
        `).join('');
      };

      window.showAddItemModal = function () {
        if (el('itemModalTitle')) el('itemModalTitle').textContent = 'â• æ–°å¢èœå–®é …ç›® | Add Menu Item';
        if (el('editItemId')) el('editItemId').value = '';
        if (el('itemEmoji')) el('itemEmoji').value = '';
        if (el('itemNameCh')) el('itemNameCh').value = '';
        if (el('itemNameEn')) el('itemNameEn').value = '';
        if (el('itemPrice')) el('itemPrice').value = '';
        if (el('itemMaxInventory')) el('itemMaxInventory').value = '50';
        if (el('itemModal')) el('itemModal').classList.add('show');
      };

      window.editItem = function (itemId) {
        const item = window.menuItems.find(i=>i.id===itemId);
        if (!item) return;
        if (el('itemModalTitle')) el('itemModalTitle').textContent = 'âœï¸ ç·¨è¼¯èœå–®é …ç›® | Edit Menu Item';
        if (el('editItemId')) el('editItemId').value = item.id;
        if (el('itemEmoji')) el('itemEmoji').value = item.emoji;
        if (el('itemNameCh')) el('itemNameCh').value = item.nameCh;
        if (el('itemNameEn')) el('itemNameEn').value = item.nameEn;
        if (el('itemPrice')) el('itemPrice').value = item.price;
        if (el('itemMaxInventory')) el('itemMaxInventory').value = (window.maxInventory[item.id]||50);
        if (el('itemModal')) el('itemModal').classList.add('show');
      };

      window.saveItem = function () {
        const editId = el('editItemId') ? el('editItemId').value : '';
        const emoji = el('itemEmoji') ? (el('itemEmoji').value || '').trim() : '';
        const nameCh = el('itemNameCh') ? (el('itemNameCh').value || '').trim() : '';
        const nameEn = el('itemNameEn') ? (el('itemNameEn').value || '').trim() : '';
        const price = el('itemPrice') ? parseInt(el('itemPrice').value || '0',10) : 0;
        const maxInv = el('itemMaxInventory') ? parseInt(el('itemMaxInventory').value || '50',10) : 50;
        if (!emoji || !nameCh || !nameEn || price <= 0) { window.showSyncStatus && window.showSyncStatus('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ | Please fill all fields','error'); return; }
        if (editId) {
          const it = window.menuItems.find(i=>i.id===parseInt(editId,10));
          if (it) { it.emoji=emoji; it.nameCh=nameCh; it.nameEn=nameEn; it.price=price; window.maxInventory[it.id]=maxInv; }
        } else {
          const newItem = { id: window.nextItemId++, emoji, nameCh, nameEn, price, canAddDrink:true };
          window.menuItems.push(newItem);
          window.maxInventory[newItem.id] = maxInv;
        }
        if (el('itemModal')) el('itemModal').classList.remove('show');
        window.renderMenu(); window.renderMenuManagement(); window.renderSettings(); window.renderStatistics(); window.saveToFirebase && window.saveToFirebase();
      };

      window.deleteItem = function(itemId) {
        window.showConfirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ| Are you sure you want to delete this item?', () => {
          const idx = window.menuItems.findIndex(i=>i.id===itemId);
          if (idx!==-1) { window.menuItems.splice(idx,1); delete window.maxInventory[itemId]; window.renderMenu(); window.renderMenuManagement(); window.renderStatistics(); window.saveToFirebase && window.saveToFirebase(); }
        });
      };

      /* -------------------------
         Extra options management
         ------------------------- */
      window.renderExtraOptionsManagement = function () {
        const grid = el('extraOptionsGrid');
        if (!grid) return;
        grid.innerHTML = window.extraOptions.map(opt => `
          <div class="settings-card">
            <div>
              <div class="stat-name">${opt.nameCh}</div>
              <div style="font-size:0.85em;color:var(--text-muted);">${opt.nameEn}</div>
            </div>
            <div style="margin-top:15px;">
              <div style="font-size:1.3em;color:var(--secondary);font-weight:700;">+${opt.price} NTD</div>
            </div>
            <div style="margin-top:15px;display:flex;gap:10px;">
              <button class="complete-btn" onclick="editExtraOption(${opt.id})" style="flex:1;background:var(--secondary)">âœï¸ ç·¨è¼¯</button>
              <button class="complete-btn" onclick="deleteExtraOption(${opt.id})" style="flex:1;background:var(--danger)">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
          </div>
        `).join('');
      };

      window.showAddExtraOptionModal = function () {
        if (el('extraOptionModalTitle')) el('extraOptionModalTitle').textContent = 'â• æ–°å¢é¡å¤–é¸é … | Add Extra Option';
        if (el('editExtraOptionId')) el('editExtraOptionId').value = '';
        if (el('extraOptionNameCh')) el('extraOptionNameCh').value = '';
        if (el('extraOptionNameEn')) el('extraOptionNameEn').value = '';
        if (el('extraOptionPrice')) el('extraOptionPrice').value = '';
        if (el('extraOptionModal')) el('extraOptionModal').classList.add('show');
      };

      window.editExtraOption = function (id) {
        const o = window.extraOptions.find(x=>x.id===id);
        if (!o) return;
        if (el('extraOptionModalTitle')) el('extraOptionModalTitle').textContent='âœï¸ ç·¨è¼¯é¡å¤–é¸é … | Edit Extra Option';
        if (el('editExtraOptionId')) el('editExtraOptionId').value = o.id;
        if (el('extraOptionNameCh')) el('extraOptionNameCh').value = o.nameCh;
        if (el('extraOptionNameEn')) el('extraOptionNameEn').value = o.nameEn;
        if (el('extraOptionPrice')) el('extraOptionPrice').value = o.price;
        if (el('extraOptionModal')) el('extraOptionModal').classList.add('show');
      };

      window.saveExtraOption = function () {
        const editId = el('editExtraOptionId') ? el('editExtraOptionId').value : '';
        const nameCh = el('extraOptionNameCh') ? (el('extraOptionNameCh').value||'').trim() : '';
        const nameEn = el('extraOptionNameEn') ? (el('extraOptionNameEn').value||'').trim() : '';
        const price = el('extraOptionPrice') ? parseInt(el('extraOptionPrice').value||'0',10):0;
        if (!nameCh || !nameEn || price<=0) { window.showSyncStatus && window.showSyncStatus('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ | Please fill all fields','error'); return; }
        if (editId) {
          const op = window.extraOptions.find(o=>o.id===parseInt(editId,10));
          if (op) { op.nameCh=nameCh; op.nameEn=nameEn; op.price=price; }
        } else { window.extraOptions.push({ id: window.nextExtraOptionId++, nameCh, nameEn, price }); }
        if (el('extraOptionModal')) el('extraOptionModal').classList.remove('show');
        window.renderExtraOptionsManagement(); window.saveToFirebase && window.saveToFirebase();
      };

      window.deleteExtraOption = function (id) {
        window.showConfirmDialog('ç¢ºå®šè¦åˆªé™¤æ­¤é¸é …å—ï¼Ÿ| Are you sure you want to delete this option?', () => {
          const idx = window.extraOptions.findIndex(o=>o.id===id);
          if (idx!==-1) { window.extraOptions.splice(idx,1); window.renderExtraOptionsManagement(); window.saveToFirebase && window.saveToFirebase(); }
        });
      };

      /* -------------------------
         Site name & theme
         ------------------------- */
      window.updateSiteName = function () {
        const header = document.querySelector('.header h1');
        if (header) header.innerHTML = `${window.siteName.emoji} ${window.siteName.chinese} ${window.siteName.english}`;
      };

      window.saveSiteName = function () {
        if (el('siteEmoji')) window.siteName.emoji = el('siteEmoji').value.trim() || window.siteName.emoji || 'ğŸ´';
        if (el('siteNameCh')) window.siteName.chinese = el('siteNameCh').value.trim() || window.siteName.chinese || 'ç¾é£Ÿç«™';
        if (el('siteNameEn')) window.siteName.english = el('siteNameEn').value.trim() || window.siteName.english || 'Food Stand';
        window.updateSiteName();
        window.saveToFirebase && window.saveToFirebase();
        window.showSyncStatus && window.showSyncStatus('âœ… ç«™é»åç¨±å·²æ›´æ–° | Site name updated','success');
      };

      window.loadSiteNameToSettings = function () {
        if (el('siteEmoji')) el('siteEmoji').value = window.siteName.emoji || '';
        if (el('siteNameCh')) el('siteNameCh').value = window.siteName.chinese || '';
        if (el('siteNameEn')) el('siteNameEn').value = window.siteName.english || '';
      };

      const colorThemes = {
        orange: { name:'æ©™è‰²ä¸»é¡Œ | Orange', primary:'#FF6B35', secondary:'#F7931E', accent:'#FDC830' },
        blue: { name:'è—è‰²ä¸»é¡Œ | Blue', primary:'#3B82F6', secondary:'#60A5FA', accent:'#93C5FD' },
        green: { name:'ç¶ è‰²ä¸»é¡Œ | Green', primary:'#10B981', secondary:'#34D399', accent:'#6EE7B7' },
        purple: { name:'ç´«è‰²ä¸»é¡Œ | Purple', primary:'#8B5CF6', secondary:'#A78BFA', accent:'#C4B5FD' },
        red: { name:'ç´…è‰²ä¸»é¡Œ | Red', primary:'#EF4444', secondary:'#F87171', accent:'#FCA5A5' }
      };

      window.renderColorThemeSelector = function () {
        const selector = el('colorThemeSelector');
        if (!selector) return;
        selector.innerHTML = Object.keys(colorThemes).map(k => {
          const t = colorThemes[k];
          const border = window.currentTheme === k ? 'border:3px solid var(--primary);' : '';
          return `
            <div class="settings-card" onclick="applyTheme('${k}')" style="cursor:pointer; ${border}">
              <h3 style="margin-bottom:15px;">${t.name}</h3>
              <div style="display:flex;gap:10px;">
                <div style="width:60px;height:60px;border-radius:12px;background:${t.primary};"></div>
                <div style="width:60px;height:60px;border-radius:12px;background:${t.secondary};"></div>
                <div style="width:60px;height:60px;border-radius:12px;background:${t.accent};"></div>
              </div>
            </div>
          `;
        }).join('');
      };

      window.applyTheme = function (themeKey) {
        if (!colorThemes[themeKey]) return;
        window.currentTheme = themeKey;
        const t = colorThemes[themeKey];
        const root = document.documentElement;
        root.style.setProperty('--primary', t.primary);
        root.style.setProperty('--secondary', t.secondary);
        root.style.setProperty('--accent', t.accent);
        try { window.renderColorThemeSelector(); } catch (e) {}
        window.saveToFirebase && window.saveToFirebase();
      };

      /* -------------------------
         Firebase save/load and realtime
         ------------------------- */
      window.saveToFirebase = async function () {
        if (!window.firebaseConfig || !window.firebaseConfig.configured || !window.firebaseDb) {
          console.warn('skip saveToFirebase: Firebase not configured');
          return;
        }
        const data = {
          menuItems: window.menuItems,
          orders: window.orders,
          orderCounter: window.orderCounter,
          maxInventory: window.maxInventory,
          currentTheme: window.currentTheme,
          siteName: window.siteName,
          extraOptions: window.extraOptions,
          nextItemId: window.nextItemId,
          nextExtraOptionId: window.nextExtraOptionId,
          lastUpdated: new Date().toISOString()
        };
        try {
          await window.firebaseDb.ref('foodstand').set(data);
          console.log('âœ… Successfully saved to Firebase');
          window.showSyncStatus && window.showSyncStatus('âœ… å·²åŒæ­¥åˆ°Firebase | Synced to Firebase','success');
        } catch (err) {
          console.error('Firebase save failed:', err);
          window.showSyncStatus && window.showSyncStatus('âŒ FirebaseåŒæ­¥å¤±æ•— | Firebase sync failed','error');
        }
      };

      window.loadFromFirebase = async function () {
        if (!window.firebaseConfig || !window.firebaseConfig.configured || !window.firebaseDb) {
          console.warn('skip loadFromFirebase: Firebase not configured');
          return;
        }
        try {
          const snapshot = await window.firebaseDb.ref('foodstand').once('value');
          const data = snapshot.val();
          if (!data) { console.log('No data in Firebase; using defaults and saving'); window.saveToFirebase && window.saveToFirebase(); return; }
          if (Array.isArray(data.menuItems)) { window.menuItems.length=0; window.menuItems.push(...data.menuItems); }
          if (Array.isArray(data.orders))  { window.orders.length=0; window.orders.push(...data.orders); }
          window.orderCounter = data.orderCounter || window.orderCounter || 0;
          if (data.maxInventory) Object.assign(window.maxInventory, data.maxInventory);
          if (data.currentTheme) { window.currentTheme = data.currentTheme; window.applyTheme && window.applyTheme(window.currentTheme); }
          if (data.siteName) Object.assign(window.siteName, data.siteName);
          if (Array.isArray(data.extraOptions)) { window.extraOptions.length=0; window.extraOptions.push(...data.extraOptions); }
          window.nextItemId = data.nextItemId || window.nextItemId;
          window.nextExtraOptionId = data.nextExtraOptionId || window.nextExtraOptionId;
          window.renderMenu(); window.updateCartDisplay(); window.updateSiteName && window.updateSiteName(); window.renderSettings && window.renderSettings(); window.renderStatistics && window.renderStatistics(); window.renderPendingOrders && window.renderPendingOrders(); window.renderCompletedOrders && window.renderCompletedOrders();
          console.log('âœ… Data loaded from Firebase');
        } catch (err) { console.error('Firebase load failed:', err); }
      };

      window.enableRealtimeSync = function () {
        if (!window.firebaseConfig || !window.firebaseConfig.configured || !window.firebaseDb) {
          console.error('Cannot enable real-time sync: Firebase not configured');
          return;
        }
        if (window.realtimeSyncEnabled) { console.log('Real-time sync already enabled'); return; }
        console.log('ğŸ”„ Enabling real-time sync...');
        window.firebaseDb.ref('foodstand').on('value', snapshot => {
          try {
            const data = snapshot.val();
            if (!data) { console.log('No data in Firebase'); return; }
            if (Array.isArray(data.menuItems)) { window.menuItems.length=0; window.menuItems.push(...data.menuItems); }
            if (Array.isArray(data.orders))  { window.orders.length=0; window.orders.push(...data.orders); }
            window.orderCounter = data.orderCounter || window.orderCounter || 0;
            if (data.maxInventory) Object.assign(window.maxInventory, data.maxInventory);
            if (data.currentTheme) window.currentTheme = data.currentTheme;
            if (data.siteName) { Object.assign(window.siteName, data.siteName); window.updateSiteName && window.updateSiteName(); }
            if (Array.isArray(data.extraOptions)) { window.extraOptions.length=0; window.extraOptions.push(...data.extraOptions); }
            window.nextItemId = data.nextItemId || window.nextItemId;
            window.nextExtraOptionId = data.nextExtraOptionId || window.nextExtraOptionId;

            // Re-render parts
            try {
              window.renderMenu(); window.updateCartDisplay();
              const kitchenView = el('kitchenView');
              if (kitchenView && !kitchenView.classList.contains('hidden')) {
                const ordersTab = el('ordersTab'), statisticsTab = el('statisticsTab'), settingsTab = el('settingsTab');
                if (ordersTab && !ordersTab.classList.contains('hidden')) { window.renderPendingOrders(); window.renderCompletedOrders(); }
                else if (statisticsTab && !statisticsTab.classList.contains('hidden')) { window.renderStatistics(); }
                else if (settingsTab && !settingsTab.classList.contains('hidden')) { window.renderColorThemeSelector(); window.renderMenuManagement(); window.renderExtraOptionsManagement(); window.renderSettings(); window.loadSiteNameToSettings(); }
              }
              console.log('âœ… UI updated from realtime data');
            } catch (renderErr) { console.error('UI render error after realtime update:', renderErr); }
          } catch (err) { console.error('Realtime on value error:', err); }
        }, err => { console.error('Firebase listener error:', err); });
        window.realtimeSyncEnabled = true;
        console.log('âœ… Real-time sync enabled');
        const syncStatus = el('syncStatus'); if (syncStatus) { syncStatus.style.display='block'; syncStatus.style.background='var(--success)'; syncStatus.style.color='white'; syncStatus.innerText='ğŸ”„ å³æ™‚è¨‚å–®åŒæ­¥å·²å•Ÿç”¨ | Real-time orders sync enabled'; setTimeout(()=>{ syncStatus.style.display='none'; },3000); }
      };

      /* -------------------------
         Admin utilities
         ------------------------- */
      window.clearCompletedOrders = function () {
        window.showConfirmDialog('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆè¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚<br>Are you sure you want to clear all completed orders? This cannot be undone.', () => {
          window.orders = window.orders.filter(o=>!o.completed);
          window.renderPendingOrders(); window.renderCompletedOrders(); window.renderStatistics(); window.saveToFirebase && window.saveToFirebase();
          window.showSyncStatus && window.showSyncStatus('âœ… å·²å®Œæˆè¨‚å–®å·²æ¸…é™¤ | Completed orders cleared','success');
        });
      };

      window.resetAllOrders = function () {
        window.showConfirmDialog('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨‚å–®å—ï¼Ÿé€™æœƒåˆªé™¤æ‰€æœ‰å¾…è™•ç†å’Œå·²å®Œæˆçš„è¨‚å–®ï¼æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚<br>Are you sure you want to reset ALL orders? This will delete all pending and completed orders! This cannot be undone.', () => {
          window.orders = [];
          window.renderPendingOrders(); window.renderCompletedOrders(); window.renderStatistics(); window.saveToFirebase && window.saveToFirebase();
          window.showSyncStatus && window.showSyncStatus('âœ… æ‰€æœ‰è¨‚å–®å·²é‡ç½® | All orders reset','success');
        });
      };

      window.resetOrderCounter = function () {
        window.showConfirmDialog('ç¢ºå®šè¦é‡ç½®è¨‚å–®ç·¨è™Ÿè¨ˆæ•¸å™¨å—ï¼Ÿä¸‹ä¸€å€‹è¨‚å–®å°‡å¾ #1 é–‹å§‹ã€‚<br>Are you sure you want to reset the order counter? Next order will start from #1.', () => {
          window.orderCounter = 0; window.saveToFirebase && window.saveToFirebase(); window.showSyncStatus && window.showSyncStatus('âœ… è¨‚å–®ç·¨è™Ÿå·²é‡ç½® | Order counter reset','success');
        });
      };

      /* -------------------------
         Kitchen view helpers and tabs
         ------------------------- */
      window.switchView = function (view) {
        const customerView = el('customerView'), kitchenView = el('kitchenView'), buttons = document.querySelectorAll('.toggle-btn');
        if (view === 'customer') {
          if (customerView) customerView.classList.remove('hidden');
          if (kitchenView) kitchenView.classList.add('hidden');
          if (buttons[0]) buttons[0].classList.add('active');
          if (buttons[1]) buttons[1].classList.remove('active');
        } else {
          if (!window.isKitchenAuthenticated) {
            if (el('passwordModal')) { el('passwordModal').classList.add('show'); if (el('passwordInput')) { el('passwordInput').value=''; el('passwordInput').focus(); } }
            return;
          }
          if (customerView) customerView.classList.add('hidden');
          if (kitchenView) kitchenView.classList.remove('hidden');
          if (buttons[0]) buttons[0].classList.remove('active');
          if (buttons[1]) buttons[1].classList.add('active');
          window.renderKitchenView && window.renderKitchenView();
        }
      };

      window.verifyPassword = function () {
        if (!el('passwordInput')) return;
        const val = el('passwordInput').value || '';
        const err = el('passwordError');
        if (val === window.KITCHEN_PASSWORD) {
          window.isKitchenAuthenticated = true;
          if (el('passwordModal')) el('passwordModal').classList.remove('show');
          window.switchView('kitchen');
        } else {
          if (err) err.style.display = 'block';
          el('passwordInput').value = '';
          el('passwordInput').focus();
        }
      };

      window.closePasswordModal = function () { if (el('passwordModal')) el('passwordModal').classList.remove('show'); if (!window.isKitchenAuthenticated) { const btns = document.querySelectorAll('.toggle-btn'); if (btns[0]) btns[0].classList.add('active'); if (btns[1]) btns[1].classList.remove('active'); } };

      window.renderKitchenView = function () { window.renderStatistics && window.renderStatistics(); window.renderSettings && window.renderSettings(); window.renderPendingOrders && window.renderPendingOrders(); window.renderCompletedOrders && window.renderCompletedOrders(); };

      /* -------------------------
         Small DOM-ready initialization
         ------------------------- */
      document.addEventListener('DOMContentLoaded', function () {
        // wire Enter key for password input
        const pi = el('passwordInput');
        if (pi) pi.addEventListener('keypress', (e) => { if (e.key === 'Enter') window.verifyPassword(); });

        // initial render
        window.renderMenu(); window.updateCartDisplay(); window.updateSiteName && window.updateSiteName(); window.loadSiteNameToSettings && window.loadSiteNameToSettings(); window.renderColorThemeSelector && window.renderColorThemeSelector();

        // try safe firebase init shortly after load (in case user filled config before)
        setTimeout(() => {
          if (window.initializeFirebaseSafe && window.initializeFirebaseSafe()) {
            // if initialized, load data and enable realtime
            window.loadFromFirebase && window.loadFromFirebase();
            window.enableRealtimeSync && window.enableRealtimeSync();
          } else {
            console.log('Firebase not auto-initialized (waiting for user configure).');
          }
        }, 250);
      });

      // Expose some functions for live-sync.js compatibility
      window.renderKitchenOrders = function () { window.renderPendingOrders && window.renderPendingOrders(); window.renderCompletedOrders && window.renderCompletedOrders(); window.renderStatistics && window.renderStatistics(); };

    })();
    </script>

    <!-- Load live-sync.js for real-time order updates -->
    <script src="live-sync.js"></script>
</body>
</html>
